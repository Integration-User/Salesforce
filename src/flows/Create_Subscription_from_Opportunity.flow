<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Provision_Subscription_New</name>
        <label>Provision Subscription New</label>
        <locationX>2558</locationX>
        <locationY>3002</locationY>
        <actionName>zephr_InvocableStartSubProvisioning</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Set_Processed</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>subscriptionIds</name>
            <value>
                <elementReference>newSubscription.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>zephr_InvocableStartSubProvisioning</nameSegment>
        <offset>0</offset>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <actionCalls>
        <name>Provision_Subscription_Renewal</name>
        <label>Provision Subscription - Renewal</label>
        <locationX>842</locationX>
        <locationY>3818</locationY>
        <actionName>zephr_InvocableStartSubProvisioning</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Set_Processed</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>subscriptionIds</name>
            <value>
                <elementReference>Get_Previous_Subscription.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>zephr_InvocableStartSubProvisioning</nameSegment>
        <offset>0</offset>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <apiVersion>54.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>Add_to_Subscription_Collection</name>
        <label>Add to Subscription Collection</label>
        <locationX>1738</locationX>
        <locationY>1406</locationY>
        <assignmentItems>
            <assignToReference>varSubsCollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_Subscription_Opportunities.Subscription__r.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_Subscription_Opportunities</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_New_Bussines_Error</name>
        <label>Assign - New Bussines Error</label>
        <locationX>1194</locationX>
        <locationY>458</locationY>
        <assignmentItems>
            <assignToReference>errorMessage</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Wrong Opportunity Record Type - Sales Development Opportunities can&apos;t be linked to a prior opportunity. </stringValue>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Assign_No_Permission</name>
        <label>Assign - No Permission</label>
        <locationX>50</locationX>
        <locationY>458</locationY>
        <assignmentItems>
            <assignToReference>errorMessage</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>You don&apos;t have permission to create subscriptions.</stringValue>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Assign_No_Product</name>
        <label>Assign - No Product</label>
        <locationX>314</locationX>
        <locationY>458</locationY>
        <assignmentItems>
            <assignToReference>errorMessage</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>This opportunity has no subscription products or all of them have been processed.</stringValue>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Assign_Renewal_Error</name>
        <label>Assign - Renewal Error</label>
        <locationX>578</locationX>
        <locationY>458</locationY>
        <assignmentItems>
            <assignToReference>errorMessage</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Wrong Opportunity Record Type - Renewal Opportunity is not linked to the Prior Opportunity. </stringValue>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Assign_Value_of_the_Most_Recent_Sub_Product_Id</name>
        <label>Assign Value of the Most Recent Sub Product Id</label>
        <locationX>1491</locationX>
        <locationY>2030</locationY>
        <assignmentItems>
            <assignToReference>varMostRecentSubProductId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Most_Recent_Sub_Product.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_Most_Recent_Sub_Product</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Create_Account_Grant</name>
        <label>Create Account Grant</label>
        <locationX>2558</locationX>
        <locationY>2786</locationY>
        <assignmentItems>
            <assignToReference>newAccountGrant.Zephr_Account__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newZephrAccount.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Subscription_Item__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newSubscriptionItem.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Zephr_Tenant__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>productTenant</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Zephr_Integration_Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Pending</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Start_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Start_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.End_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.End_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Product__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Product2Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Insert_Account_Grant_New</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Create_Account_Grant_0</name>
        <label>Create Account Grant</label>
        <locationX>842</locationX>
        <locationY>3602</locationY>
        <assignmentItems>
            <assignToReference>newAccountGrant.Zephr_Account__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Previous_Subscription.Zephr_Account__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Subscription_Item__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newSubscriptionItem.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Zephr_Tenant__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>productTenant</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Zephr_Integration_Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Pending</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Start_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Start_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.End_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.End_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newAccountGrant.Product__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Product2Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Insert_Account_Grant_Renewal</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Create_Renewal_Subscription_Product</name>
        <label>Create Renewal Subscription Product</label>
        <locationX>974</locationX>
        <locationY>3170</locationY>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.Subscription__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Previous_Subscription.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.Product__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Product2Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.Start_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Start_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.End_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.End_Date__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Insert_Subscription_Product_Renewal</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Create_Subscription_0</name>
        <label>Create Subscription</label>
        <locationX>2756</locationX>
        <locationY>1082</locationY>
        <assignmentItems>
            <assignToReference>newSubscription.Account__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Opportunity_Details.AccountId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscription.CurrencyIsoCode</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Opportunity_Details.CurrencyIsoCode</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscription.Number_of_Seats__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>fNumberOfSeats</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscription.Type__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Group</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscription.Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Active</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscription.Opportunity__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Opportunity_Details.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscription.Subscription_Management_System__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varSubscriptionManagementSystem</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Insert_Subscription</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Create_Subscription_Product</name>
        <label>Create Subscription Product</label>
        <locationX>2756</locationX>
        <locationY>1406</locationY>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.Subscription__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newSubscription.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.Product__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Product2Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.Start_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Start_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newSubscriptionItem.End_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.End_Date__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Insert_Subscription_Product</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Create_Zephr_Account_0</name>
        <label>Create Zephr Account</label>
        <locationX>2558</locationX>
        <locationY>2354</locationY>
        <assignmentItems>
            <assignToReference>newZephrAccount.Zephr_Company__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>zephrCompanyId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newZephrAccount.Subscription__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newSubscription.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newZephrAccount.Number_of_Seats__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newSubscription.Number_of_Seats__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newZephrAccount.Zephr_Tenant__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>productTenant</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newZephrAccount.Zephr_Integration_Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Pending</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newZephrAccount.Name</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>zephrAccountName</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>newZephrAccount.Name</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>zephrAccountName</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Insert_Zephr_Account</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Company_Id</name>
        <label>Set Company Id</label>
        <locationX>2426</locationX>
        <locationY>2162</locationY>
        <assignmentItems>
            <assignToReference>zephrCompanyId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Create_Company_0</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Create_Zephr_Account_0</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Company_Id_0</name>
        <label>Set Company Id</label>
        <locationX>2690</locationX>
        <locationY>2054</locationY>
        <assignmentItems>
            <assignToReference>zephrCompanyId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Zephr_Company.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Create_Zephr_Account_0</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Processed</name>
        <label>Set Processed</label>
        <locationX>2331</locationX>
        <locationY>4430</locationY>
        <assignmentItems>
            <assignToReference>Loop_Products.Subscription_Product_Created__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Order_Product</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Subscription_for_Update_0</name>
        <label>Set Subscription for Update</label>
        <locationX>2558</locationX>
        <locationY>2570</locationY>
        <assignmentItems>
            <assignToReference>subscriptionToUpdate.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newSubscription.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>subscriptionToUpdate.Zephr_Account__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>newZephrAccount.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Subscription</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Subscription_Parameters</name>
        <label>Set Subscription Parameters</label>
        <locationX>1106</locationX>
        <locationY>2762</locationY>
        <assignmentItems>
            <assignToReference>Get_Previous_Subscription.Number_of_Seats__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>fNumberOfSeats</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Previous_Subscription</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Tenant</name>
        <label>Set Tenant</label>
        <locationX>2331</locationX>
        <locationY>866</locationY>
        <assignmentItems>
            <assignToReference>productTenant</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Products.Product2.Zephr_Tenant__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Opportunity_Type</targetReference>
        </connector>
    </assignments>
    <collectionProcessors>
        <name>Keep_Only_the_Most_Recent_Subscription_Product</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Keep Only the Most Recent Subscription Product</label>
        <locationX>1403</locationX>
        <locationY>1814</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>Get_Previous_Subscription_Products</collectionReference>
        <connector>
            <targetReference>Loop_Most_Recent_Sub_Product</targetReference>
        </connector>
        <limit>1</limit>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>End_Date__c</sortField>
            <sortOrder>Desc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <decisions>
        <name>Company_Exists</name>
        <label>Company Exists?</label>
        <locationX>2558</locationX>
        <locationY>1946</locationY>
        <defaultConnector>
            <targetReference>Set_Company_Id_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Zephr_Company.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_Company_0</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Less_Seats_than_Subscribers</name>
        <label>Less Seats than Subscribers?</label>
        <locationX>974</locationX>
        <locationY>2654</locationY>
        <defaultConnector>
            <targetReference>Set_Subscription_Parameters</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes_LSTS</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Previous_Subscription.Seats_Allocated__c</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <elementReference>fNumberOfSeats</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_Subscription_Change</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <description>It&apos;s a renewal if the Order.Opportunity.Previous_Opportunity__c field is populated, and an amendment if the Order.Opportunity.Original_Opportunity__c is.</description>
        <name>Opportunity_Type</name>
        <label>Opportunity Type</label>
        <locationX>2331</locationX>
        <locationY>974</locationY>
        <defaultConnector>
            <targetReference>Create_Subscription_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>New Business</defaultConnectorLabel>
        <rules>
            <name>Opportunity_Type_Renewal</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Prior_Opportunity__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Sales_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Previous_Subscripition_Opportunities</targetReference>
            </connector>
            <label>Renewal</label>
        </rules>
    </decisions>
    <decisions>
        <name>Previous_Subscription_Found</name>
        <label>Previous Subscription Found</label>
        <locationX>1172</locationX>
        <locationY>2546</locationY>
        <defaultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Create_Subscription_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Previous_Subscription_Found_Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Previous_Subscription</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Less_Seats_than_Subscribers</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Previous_Subscription_Product_Found</name>
        <label>Previous Subscription Product Found?</label>
        <locationX>1403</locationX>
        <locationY>2330</locationY>
        <defaultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Create_Subscription_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Previous_Subscription_Product_Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Previous_Subscription_Product.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Previous_Subscription</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Previous_Subscription_Products_Found</name>
        <label>Previous Subscription Products Found?</label>
        <locationX>1650</locationX>
        <locationY>1706</locationY>
        <defaultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Create_Subscription_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Found_Subscription_Products_Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Previous_Subscription_Products</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Keep_Only_the_Most_Recent_Subscription_Product</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Process_Order</name>
        <label>Process Order?</label>
        <locationX>754</locationX>
        <locationY>350</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>No_Permission</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>validationResult</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>No Permission</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_No_Permission</targetReference>
            </connector>
            <label>No Permission</label>
        </rules>
        <rules>
            <name>Product_Not_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Opportunity_Products</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>validationResult</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>No Permission</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_No_Product</targetReference>
            </connector>
            <label>Product Not Found</label>
        </rules>
        <rules>
            <name>Renewal_Error</name>
            <conditionLogic>1 AND (2 OR 3) AND 4 AND 5</conditionLogic>
            <conditions>
                <leftValueReference>validationResult</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>OK</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Existing_Business</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Renewal_Closed</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Prior_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Sales_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Renewal_Error</targetReference>
            </connector>
            <label>Renewal - Error</label>
        </rules>
        <rules>
            <name>Renewal_Process</name>
            <conditionLogic>1 AND (2 OR 3) AND (4 OR 5)</conditionLogic>
            <conditions>
                <leftValueReference>validationResult</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>OK</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Existing_Business</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Renewal_Closed</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Prior_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Sales_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Loop_Products</targetReference>
            </connector>
            <label>Renewal - Process</label>
        </rules>
        <rules>
            <name>New_Business_Process</name>
            <conditionLogic>1 AND 4 AND 5 AND (2 OR 3)</conditionLogic>
            <conditions>
                <leftValueReference>validationResult</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>OK</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Sales_Opportunity</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Sales_Opportunity_Closed</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Prior_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Sales_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Loop_Products</targetReference>
            </connector>
            <label>New Business - Process</label>
        </rules>
        <rules>
            <name>New_Business_Error</name>
            <conditionLogic>1 AND (2 OR 3) AND (4 OR 5)</conditionLogic>
            <conditions>
                <leftValueReference>validationResult</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>OK</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Sales_Opportunity</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Sales_Opportunity_Closed</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Prior_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Opportunity_Details.Sales_Opportunity__r.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_New_Bussines_Error</targetReference>
            </connector>
            <label>New Business - Error</label>
        </rules>
    </decisions>
    <decisions>
        <name>Renewal_Update_Zephr_Subscription</name>
        <label>Renewal Update Zephr Subscription</label>
        <locationX>974</locationX>
        <locationY>3494</locationY>
        <defaultConnector>
            <targetReference>Set_Processed</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Renewal_Update_Zephr_Subscription_Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_Products.Is_Zephr_Product__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_Account_Grant_0</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Subscription_Opportunities_Found</name>
        <label>Subscription Opportunities Found?</label>
        <locationX>1906</locationX>
        <locationY>1190</locationY>
        <defaultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Create_Subscription_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Subscription_Opportunities_Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Previous_Subscripition_Opportunities</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Loop_Subscription_Opportunities</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Update_Zephr_Single_Year_Subscription</name>
        <label>Update Zephr Single Year Subscription</label>
        <locationX>2756</locationX>
        <locationY>1730</locationY>
        <defaultConnector>
            <targetReference>Set_Processed</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Update_Zephr_Single_Year_Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_Products.Is_Zephr_Product__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Zephr_Company</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <environments>Default</environments>
    <formulas>
        <name>fNumberOfSeats</name>
        <dataType>Number</dataType>
        <expression>IF(
  AND(
    NOT(ISBLANK({!Loop_Products.Product2.Number_of_Licences__c})),
    {!Loop_Products.Product2.Number_of_Licences__c} &gt; 0
  ),
{!Loop_Products.Licenses__c}* {!Loop_Products.Product2.Number_of_Licences__c},
  {!Loop_Products.Licenses__c}
)</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>validationResult</name>
        <dataType>String</dataType>
        <expression>IF( !{!$Permission.IJ_Entitlements}, &apos;No Permission&apos;,
&apos;OK&apos;
)</expression>
    </formulas>
    <formulas>
        <description>Calculates the right subscription management system based on the product being processed</description>
        <name>varSubscriptionManagementSystem</name>
        <dataType>String</dataType>
        <expression>&quot;Zephr&quot;</expression>
    </formulas>
    <formulas>
        <name>zephrAccountName</name>
        <dataType>String</dataType>
        <expression>LEFT({!Get_Opportunity_Details.Account.Name}, 63) + &apos; - &apos; + {!RefreshSubscriptionDetails.Name}</expression>
    </formulas>
    <interviewLabel>Create Subscription from Opportunity {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Create Subscription from Opportunity</label>
    <loops>
        <name>Loop_Most_Recent_Sub_Product</name>
        <label>Loop Most Recent Sub Product</label>
        <locationX>1403</locationX>
        <locationY>1922</locationY>
        <collectionReference>Get_Previous_Subscription_Products</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Assign_Value_of_the_Most_Recent_Sub_Product_Id</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Get_Previous_Subscription_Product</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Loop_Products</name>
        <label>Loop Products</label>
        <locationX>754</locationX>
        <locationY>758</locationY>
        <collectionReference>Get_Opportunity_Products</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Set_Tenant</targetReference>
        </nextValueConnector>
    </loops>
    <loops>
        <name>Loop_Subscription_Opportunities</name>
        <label>Loop Subscription Opportunities</label>
        <locationX>1650</locationX>
        <locationY>1298</locationY>
        <collectionReference>Get_Previous_Subscripition_Opportunities</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Add_to_Subscription_Collection</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Get_Previous_Subscription_Products</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>Create_Company_0</name>
        <label>Create Company</label>
        <locationX>2426</locationX>
        <locationY>2054</locationY>
        <connector>
            <targetReference>Set_Company_Id</targetReference>
        </connector>
        <inputAssignments>
            <field>Account__c</field>
            <value>
                <elementReference>Get_Opportunity_Details.AccountId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Zephr_Integration_Status__c</field>
            <value>
                <stringValue>Pending</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Zephr_Tenant__c</field>
            <value>
                <elementReference>productTenant</elementReference>
            </value>
        </inputAssignments>
        <object>Zephr_Company__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>Create_Subscription_Change</name>
        <label>Create Subscription Change</label>
        <locationX>842</locationX>
        <locationY>2762</locationY>
        <connector>
            <targetReference>Update_Subscription_User_End_Date</targetReference>
        </connector>
        <inputAssignments>
            <field>End_Date__c</field>
            <value>
                <elementReference>Loop_Products.End_Date__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Number_of_Seats__c</field>
            <value>
                <elementReference>fNumberOfSeats</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Opportunity__c</field>
            <value>
                <elementReference>Loop_Products.OpportunityId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Start_Date__c</field>
            <value>
                <elementReference>Loop_Products.Start_Date__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Status__c</field>
            <value>
                <stringValue>Pending</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Subscription__c</field>
            <value>
                <elementReference>Get_Previous_Subscription.Id</elementReference>
            </value>
        </inputAssignments>
        <object>Subscription_Change__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>Insert_Account_Grant_New</name>
        <label>Insert Account Grant New</label>
        <locationX>2558</locationX>
        <locationY>2894</locationY>
        <connector>
            <targetReference>Provision_Subscription_New</targetReference>
        </connector>
        <inputReference>newAccountGrant</inputReference>
    </recordCreates>
    <recordCreates>
        <name>Insert_Account_Grant_Renewal</name>
        <label>Insert Account Grant - Renewal</label>
        <locationX>842</locationX>
        <locationY>3710</locationY>
        <connector>
            <targetReference>Provision_Subscription_Renewal</targetReference>
        </connector>
        <inputReference>newAccountGrant</inputReference>
    </recordCreates>
    <recordCreates>
        <name>Insert_Subscription</name>
        <label>Insert Subscription</label>
        <locationX>2756</locationX>
        <locationY>1190</locationY>
        <connector>
            <targetReference>RefreshSubscriptionDetails</targetReference>
        </connector>
        <inputReference>newSubscription</inputReference>
    </recordCreates>
    <recordCreates>
        <name>Insert_Subscription_Opportunity</name>
        <label>Insert Subscription Opportunity</label>
        <locationX>974</locationX>
        <locationY>3386</locationY>
        <connector>
            <targetReference>Renewal_Update_Zephr_Subscription</targetReference>
        </connector>
        <inputAssignments>
            <field>Opportunity__c</field>
            <value>
                <elementReference>Get_Opportunity_Details.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Subscription__c</field>
            <value>
                <elementReference>Get_Previous_Subscription.Id</elementReference>
            </value>
        </inputAssignments>
        <object>Subscription_Opportunity__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>Insert_Subscription_Opportunity_New_Business</name>
        <label>Insert Subscription Opportunity</label>
        <locationX>2756</locationX>
        <locationY>1622</locationY>
        <connector>
            <targetReference>Update_Zephr_Single_Year_Subscription</targetReference>
        </connector>
        <inputAssignments>
            <field>Opportunity__c</field>
            <value>
                <elementReference>Get_Opportunity_Details.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Subscription__c</field>
            <value>
                <elementReference>RefreshSubscriptionDetails.Id</elementReference>
            </value>
        </inputAssignments>
        <object>Subscription_Opportunity__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>Insert_Subscription_Product</name>
        <label>Insert Subscription Product</label>
        <locationX>2756</locationX>
        <locationY>1514</locationY>
        <connector>
            <targetReference>Insert_Subscription_Opportunity_New_Business</targetReference>
        </connector>
        <inputReference>newSubscriptionItem</inputReference>
    </recordCreates>
    <recordCreates>
        <name>Insert_Subscription_Product_Renewal</name>
        <label>Insert Subscription Product Renewal</label>
        <locationX>974</locationX>
        <locationY>3278</locationY>
        <connector>
            <targetReference>Insert_Subscription_Opportunity</targetReference>
        </connector>
        <inputReference>newSubscriptionItem</inputReference>
    </recordCreates>
    <recordCreates>
        <name>Insert_Zephr_Account</name>
        <label>Insert Zephr Account</label>
        <locationX>2558</locationX>
        <locationY>2462</locationY>
        <connector>
            <targetReference>Set_Subscription_for_Update_0</targetReference>
        </connector>
        <inputReference>newZephrAccount</inputReference>
    </recordCreates>
    <recordLookups>
        <name>Get_Opportunity_Details</name>
        <label>Get Opportunity Details</label>
        <locationX>754</locationX>
        <locationY>134</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Opportunity_Products</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>recordId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Opportunity_Products</name>
        <label>Get Opportunity Products</label>
        <locationX>754</locationX>
        <locationY>242</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Process_Order</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OpportunityId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>recordId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Is_Zephr_Product__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Subscription_Product_Created__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>OpportunityLineItem</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Previous_Subscripition_Opportunities</name>
        <label>Get Previous Subscripition Opportunities</label>
        <locationX>1906</locationX>
        <locationY>1082</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Subscription_Opportunities_Found</targetReference>
        </connector>
        <filterLogic>(1 OR 4) AND 2 AND 3</filterLogic>
        <filters>
            <field>Opportunity__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Opportunity_Details.Prior_Opportunity__r.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Subscription_Status__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Active</stringValue>
            </value>
        </filters>
        <filters>
            <field>Subscription_Type__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Group</stringValue>
            </value>
        </filters>
        <filters>
            <field>Opportunity__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Opportunity_Details.Sales_Opportunity__r.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Subscription_Opportunity__c</object>
        <sortField>CreatedDate</sortField>
        <sortOrder>Asc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Previous_Subscription</name>
        <label>Get Previous Subscription</label>
        <locationX>1172</locationX>
        <locationY>2438</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Previous_Subscription_Found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Previous_Subscription_Product.Subscription__r.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Subscription__c</object>
        <sortField>LastModifiedDate</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Previous_Subscription_Product</name>
        <label>Get Previous Subscription Product</label>
        <locationX>1403</locationX>
        <locationY>2222</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Previous_Subscription_Product_Found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>varMostRecentSubProductId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Subscription_Product__c</object>
        <sortField>End_Date__c</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Previous_Subscription_Products</name>
        <label>Get Previous Subscription Products</label>
        <locationX>1650</locationX>
        <locationY>1598</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Previous_Subscription_Products_Found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Subscription__c</field>
            <operator>In</operator>
            <value>
                <elementReference>varSubsCollection</elementReference>
            </value>
        </filters>
        <filters>
            <field>Zephr_Entitlement_Id__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Loop_Products.Product2.ZephrEntitlementId__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Subscription_Product__c</object>
        <sortField>End_Date__c</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Zephr_Company</name>
        <label>Get Zephr Company</label>
        <locationX>2558</locationX>
        <locationY>1838</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Company_Exists</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Zephr_Tenant__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>productTenant</elementReference>
            </value>
        </filters>
        <filters>
            <field>Account__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Opportunity_Details.AccountId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Zephr_Company__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Refresh the data from the database - we need the Name (autonumber)</description>
        <name>RefreshSubscriptionDetails</name>
        <label>Refresh Subscription Details</label>
        <locationX>2756</locationX>
        <locationY>1298</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Create_Subscription_Product</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>newSubscription.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Subscription__c</object>
        <queriedFields>Id</queriedFields>
        <queriedFields>Name</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Order_Product</name>
        <label>Update Order Product</label>
        <locationX>2331</locationX>
        <locationY>4538</locationY>
        <connector>
            <targetReference>Loop_Products</targetReference>
        </connector>
        <inputReference>Loop_Products</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Previous_Subscription</name>
        <label>Update Previous Subscription</label>
        <locationX>1106</locationX>
        <locationY>2870</locationY>
        <connector>
            <targetReference>Update_Subscription_User_End_Date</targetReference>
        </connector>
        <inputReference>Get_Previous_Subscription</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Subscription</name>
        <label>Update Subscription</label>
        <locationX>2558</locationX>
        <locationY>2678</locationY>
        <connector>
            <targetReference>Create_Account_Grant</targetReference>
        </connector>
        <inputReference>subscriptionToUpdate</inputReference>
    </recordUpdates>
    <recordUpdates>
        <description>If subscriber end dates match the current end date, we extend to the new end date</description>
        <name>Update_Subscription_User_End_Date</name>
        <label>Update Subscription User End Date</label>
        <locationX>974</locationX>
        <locationY>3062</locationY>
        <connector>
            <targetReference>Create_Renewal_Subscription_Product</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Subscriber_End_Date__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>Get_Previous_Subscription.End_Date__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Subscription_NG__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Previous_Subscription.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Subscriber_End_Date__c</field>
            <value>
                <elementReference>Loop_Products.End_Date__c</elementReference>
            </value>
        </inputAssignments>
        <object>Subscription_User__c</object>
    </recordUpdates>
    <runInMode>SystemModeWithoutSharing</runInMode>
    <start>
        <locationX>628</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Get_Opportunity_Details</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>errorMessage</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>newAccountGrant</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Zephr_Account_Grant__c</objectType>
    </variables>
    <variables>
        <name>newSubscription</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Subscription__c</objectType>
    </variables>
    <variables>
        <name>newSubscriptionItem</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Subscription_Product__c</objectType>
    </variables>
    <variables>
        <name>newZephrAccount</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Zephr_Account__c</objectType>
    </variables>
    <variables>
        <name>productTenant</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>recordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>subscriptionsToUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Subscription__c</objectType>
    </variables>
    <variables>
        <name>subscriptionToUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Subscription__c</objectType>
    </variables>
    <variables>
        <name>varMostRecentSubProductId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>varSubsCollection</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>zephrCompanyId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
