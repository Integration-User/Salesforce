<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Go_to_Subscription</name>
        <label>Go to Subscription</label>
        <locationX>176</locationX>
        <locationY>854</locationY>
        <actionName>c:NavigateToRecord</actionName>
        <actionType>component</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>recordId</name>
            <value>
                <elementReference>Get_Subscription_User.Subscription_NG__c</elementReference>
            </value>
        </inputParameters>
        <nameSegment>c:NavigateToRecord</nameSegment>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <actionCalls>
        <name>Post_Error_to_Chatter</name>
        <label>Post Error to Chatter</label>
        <locationX>440</locationX>
        <locationY>518</locationY>
        <actionName>chatterPost</actionName>
        <actionType>chatterPost</actionType>
        <connector>
            <targetReference>scr_Error_Screen</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>text</name>
            <value>
                <elementReference>postErrorText</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>subjectNameOrId</name>
            <value>
                <elementReference>Get_Subscription_User.Subscription_NG__c</elementReference>
            </value>
        </inputParameters>
        <nameSegment>chatterPost</nameSegment>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <apiVersion>52.0</apiVersion>
    <decisions>
        <name>SRP</name>
        <label>SRP?</label>
        <locationX>176</locationX>
        <locationY>518</locationY>
        <defaultConnector>
            <targetReference>SuccessDisplay</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>SRP_Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Subscription.Subscription_Management_System__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>SRP Auth0</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SuccessDisplay</targetReference>
            </connector>
            <label>SRP</label>
        </rules>
    </decisions>
    <description>V17 &amp; V18 - Update to set SRP Sync Status to Pending
V15 - Removed Sync to SRP - users will need to do this manually
V14 - Updated to use invocable for SRP because we removed the trigger. Also added notification.
V13
Updated to just update Subscription User because the update trigger handles removing the records from Zephr
V12
Improved error handling

V11

Changed the inactive Subscriber Status value to &quot;Inactive&quot; rather than &quot;Removed&quot; since Removed doesn&apos;t work for new users who are going to be activated
V10

Updated to set the End Date and Status rather than deleting the Subscription User record</description>
    <environments>Default</environments>
    <formulas>
        <description>This flow updates the End Date to the current date / time. We need to make sure that the current Start Date isn&apos;t after this, so this formula sets the Start Date to NOW() if the current Start Date would be after the new End Date</description>
        <name>fNewSubscriptionUserStartDate</name>
        <dataType>DateTime</dataType>
        <expression>IF({!Get_Subscription_User.Subscriber_Start_Date__c} &gt; {!$Flow.CurrentDateTime},{!$Flow.CurrentDateTime},  {!Get_Subscription_User.Subscriber_Start_Date__c})</expression>
    </formulas>
    <interviewLabel>Delete Subscription User {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Delete Subscription User</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordLookups>
        <name>Get_Subscription</name>
        <label>Get Subscription</label>
        <locationX>176</locationX>
        <locationY>278</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Update_Subscription_User</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Subscription_User.Subscription_NG__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Subscription__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Subscription_User</name>
        <label>Get Subscription User</label>
        <locationX>176</locationX>
        <locationY>158</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Subscription</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Post_Error_to_Chatter</targetReference>
        </faultConnector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>recordId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Subscription_User__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordRollbacks>
        <name>Rollback</name>
        <label>Rollback</label>
        <locationX>440</locationX>
        <locationY>758</locationY>
        <connector>
            <isGoTo>true</isGoTo>
            <targetReference>Go_to_Subscription</targetReference>
        </connector>
    </recordRollbacks>
    <recordUpdates>
        <name>Update_Subscription_User</name>
        <label>Update Subscription User</label>
        <locationX>176</locationX>
        <locationY>398</locationY>
        <connector>
            <targetReference>SRP</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Post_Error_to_Chatter</targetReference>
        </faultConnector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Subscription_User.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>SRP_Integration_Status__c</field>
            <value>
                <stringValue>Pending</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Subscriber_End_Date__c</field>
            <value>
                <elementReference>$Flow.CurrentDateTime</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Subscriber_Start_Date__c</field>
            <value>
                <elementReference>fNewSubscriptionUserStartDate</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Subscriber_Status__c</field>
            <value>
                <stringValue>Inactive</stringValue>
            </value>
        </inputAssignments>
        <object>Subscription_User__c</object>
    </recordUpdates>
    <screens>
        <name>scr_Error_Screen</name>
        <label>Error Screen</label>
        <locationX>440</locationX>
        <locationY>638</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Rollback</targetReference>
        </connector>
        <fields>
            <name>txtErrorMessage</name>
            <fieldText>&lt;p&gt;An error occurred when deleting the subscriber. Please report the following message:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;strong style=&quot;color: rgb(255, 0, 0);&quot;&gt;{!$Flow.FaultMessage}&lt;/strong&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>SuccessDisplay</name>
        <label>Success</label>
        <locationX>176</locationX>
        <locationY>734</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <connector>
            <targetReference>Go_to_Subscription</targetReference>
        </connector>
        <fields>
            <name>ProblemDisplay_0</name>
            <fieldText>&lt;p&gt;The user was successfully removed.&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>50</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Get_Subscription_User</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <textTemplates>
        <name>postErrorText</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>An error occurred in the Delete Subscription User flow:
{!$Flow.FaultMessage}</text>
    </textTemplates>
    <variables>
        <name>lstSubscriptionUsers</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Subscription_User__c</objectType>
    </variables>
    <variables>
        <name>recordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
